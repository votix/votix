let StarRatingGenerator=typeof StarRatingGenerator==='undefined'?0:StarRatingGenerator+1;(function initStarRating(starRatingGeneratorIndex){if(starRatingGeneratorIndex===0&&!document.querySelector('script[src="https://www.gstatic.com/firebasejs/8.1.1/firebase-database.js"]')){loadDependencies()}function loadDependencies(){const firebaseAppScript=document.createElement('script');firebaseAppScript.src='https://www.gstatic.com/firebasejs/8.1.1/firebase-app.js';document.head.appendChild(firebaseAppScript);firebaseAppScript.onload=function(){const firebaseDatabaseScript=document.createElement('script');firebaseDatabaseScript.src='https://www.gstatic.com/firebasejs/8.1.1/firebase-database.js';document.head.appendChild(firebaseDatabaseScript)};const styleElement=document.createElement('style');styleElement.innerHTML=`@keyframes dawaj{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}.kozyr-SRS-loader~div{visibility:hidden}`;document.head.appendChild(styleElement)}function updateStars(element,rating,starSize){const stars=element.getElementsByTagName('star');stars.forEach((star,i)=>{if(i<=rating){if(i<Math.floor(rating)){setStarDisplay(star,'full',starSize)}else{const partialFill=rating-Math.floor(rating);setPartialStarDisplay(star,partialFill,starSize)}}else{setStarDisplay(star,'empty',starSize)}})}function setStarDisplay(star,type,starSize){const fullElement=star.querySelector('full');const emptyElement=star.querySelector('empty');const hoverElement=star.querySelector('hover');if(type==='full'){fullElement.style.width='100%';emptyElement.style.width='0%'}else if(type==='empty'){fullElement.style.width='0%';emptyElement.style.width='100%';emptyElement.querySelector('img').style.margin='0 0 0 0'}hoverElement.style.width='0%'}function setPartialStarDisplay(star,fillRatio,starSize){const width=Math.round(fillRatio*starSize);const fullElement=star.querySelector('full');const emptyElement=star.querySelector('empty');fullElement.style.width=width+'px';emptyElement.style.width=(starSize-width)+'px';emptyElement.querySelector('img').style.margin='0 0 0 -'+width+'px'}function showThankYouMessage(message,ratingElement,userRating){const thankYouDiv=createThankYouElement(message,userRating);document.body.appendChild(thankYouDiv);const elementRect=ratingElement.getBoundingClientRect();setTimeout(()=>{positionThankYouMessage(thankYouDiv,ratingElement,elementRect)},10);setTimeout(()=>{fadeOutAndRemoveMessage(thankYouDiv)},3500)}function createThankYouElement(message,userRating){const div=document.createElement('div');div.innerHTML=message.replace(/\$userRating\$/g,userRating);Object.assign(div.style,{position:'absolute',background:'white',color:'black',border:'1px solid #e0e0e0',borderRadius:'3px',padding:'3px 7px',lineHeight:'1.2',fontSize:'12px',opacity:'0',transition:'opacity 1s',width:'200px',boxSizing:'border-box',zIndex:'9999999',cursor:'default'});return div}function positionThankYouMessage(thankYouDiv,ratingElement,elementRect){thankYouDiv.style.opacity='1';const align=ratingElement.style.textAlign;if(align==='right'){thankYouDiv.style.left=window.scrollX+elementRect.left+ratingElement.offsetWidth-200+'px'}else if(align==='center'){thankYouDiv.style.left=window.scrollX+elementRect.left+ratingElement.offsetWidth/2-100+'px'}else{thankYouDiv.style.left=window.scrollX+elementRect.left+'px'}thankYouDiv.style.top=(elementRect.top>thankYouDiv.offsetHeight?window.scrollY+elementRect.top-thankYouDiv.offsetHeight:window.scrollY+elementRect.top+thankYouDiv.offsetHeight)+'px'}function fadeOutAndRemoveMessage(thankYouDiv){thankYouDiv.style.opacity='0';setTimeout(()=>{document.body.removeChild(thankYouDiv)},1000)}function initializeRating(index){const ratingElement=document.querySelectorAll('.kozyr-SRS')[index];const currentUrl=getCurrentUrl();const ratingConfig=getRatingConfig(ratingElement,currentUrl);const container=createRatingContainer(ratingConfig);ratingElement.parentNode.insertBefore(container,ratingElement);setupRatingElements(container,ratingConfig);initializeFirebase(container,ratingConfig,currentUrl)}function getCurrentUrl(){const url=location.host.replace('www.','').replace(/\./g,'_').replace(/\//g,'__');return url===''?'default':url}function getRatingConfig(element,currentUrl){return{name:getRatingName(element,currentUrl),starImages:{empty:element.getAttribute('emptyStarImg')||'https://1.bp.blogspot.com/-pOr9XGwtSJc/Wsjf8ULOIqI/AAAAAAAAAKE/KBh-LUDIn0YzASKf-t7mQo8UNpdHhr2SgCLcBGAs/s1600/pusta.png',full:element.getAttribute('fullStarImg')||'https://3.bp.blogspot.com/-QSNdWP4Ijx4/Wsjf7QOUZ4I/AAAAAAAAAJ8/F2nReVG5WfA1rLV3dGcAFMsPOnIQck4YwCLcBGAs/s1600/pelna.png',hover:element.getAttribute('hoverStarImg')||null},starSize:getStarSize(element),firebaseURL:getFirebaseUrl(element),align:getAlignment(element),textSettings:getTextSettings(element),fontSettings:getFontSettings(element),readonly:element.getAttribute('readonly')==='readonly',texts:{top:element.getAttribute('topText')||'Рейтинг:',bottom:element.getAttribute('bottomText')||'Среднее: <b>$average$</b> / $max$ (<b>$votes$</b> голосов)',thankYou:element.getAttribute('thankYouText')||'Спасибо за ваш голос'},numberOfStars:getNumberOfStars(element)}}function getRatingName(element,currentUrl){let name=element.getAttribute('ratingName');if(!name||name==='auto'){name=getAutoRatingName()}return name.replace(/[\s#.@!$%&()]/g,'-')}function getAutoRatingName(){let href=location.href.split('?')[0].split('#')[0].replace(location.protocol+'//','').replace('www.','');if(href.charAt(href.length-1)==='/'||href.charAt(href.length-1)==='.'){href=href.substring(0,href.length-1)}return href.replace(/[.,\s]/g,'_')}function getStarSize(element){const size=element.getAttribute('starSize');return(!size||Number(size)<0||isNaN(size))?25:Number(size)}function getFirebaseUrl(element){let url=element.getAttribute('firebaseURL');if(url===null){return'Ошибка Firebase. Добавьте атрибут firebaseURL="https://YOUR-FIREBASE.firebaseio.com" к вашему скрипту рейтинга.'}return validateAndFormatFirebaseUrl(url)}function validateAndFormatFirebaseUrl(url){if(url===''){return'Ошибка Firebase. Введите URL-адрес вашего Firebase в атрибут "firebaseURL" в вашем скрипте рейтинга.'}if(url.indexOf('https://')!==0||url.indexOf('firebaseio.com')<5){return'Ошибка Firebase. Неверный URL Firebase'}return url.charAt(url.length-1)!=='/'?url+'/':url}function getAlignment(element){const align=element.getAttribute('align');return align==='right'||align==='left'?align:'center'}function getTextSettings(element){const size=element.getAttribute('textSize');return{size:(!size||Number(size)<0||isNaN(size))?15:Number(size),color:element.getAttribute('textColor')||'black'}}function getFontSettings(element){const fontFamily=element.getAttribute('fontFamily');return getFontFamilyValue(fontFamily)}function getFontFamilyValue(font){const fontMap={'Georgia':'Georgia, serif','Times New Roman':'"Times New Roman", Times, serif','Arial':'Arial, Helvetica, sans-serif','Arial Black':'"Arial Black", Gadget, sans-serif','Comic Sans':'"Comic Sans MS", cursive, sans-serif','Impact':'Impact, Charcoal, sans-serif','Lucida Sans':'"Lucida Sans Unicode", "Lucida Grande", sans-serif','Lucida Console':'"Lucida Console", Monaco, monospace','Palatino':'"Palatino Linotype", "Book Antiqua", Palatino, serif','Tahoma':'Tahoma, Geneva, sans-serif','Trebuchet':'"Trebuchet MS", Helvetica, sans-serif','Courier New':'"Courier New", Courier, monospace','Verdana':'Verdana, Geneva, sans-serif'};return fontMap[font]||'inherit'}function getNumberOfStars(element){const stars=Number(element.getAttribute('numberOfStars'));return stars<1||isNaN(stars)?5:stars}function createRatingContainer(config){const container=document.createElement('div');container.setAttribute('ratingName',config.name);Object.assign(container.style,{textAlign:config.align,position:'relative',cursor:'default'});container.oncontextmenu=(event)=>{event.preventDefault();return false};return container}function setupRatingElements(container,config){const loader=createLoader(config);const textElements=createTextElements(config);const starsContainer=createStarsContainer(config);container.appendChild(loader);container.appendChild(textElements.top);container.appendChild(starsContainer);container.appendChild(textElements.bottom);updateStars(container,0,config.starSize)}function createLoader(config){const loader=document.createElement('div');loader.setAttribute('class','kozyr-SRS-loader');Object.assign(loader.style,{borderTop:'6px solid #3498db',borderRadius:'50%',border:'6px solid #f3f3f3',width:'25px',height:'25px',animation:'dawaj 1s linear infinite',margin:config.align==='center'?'auto':config.align==='right'?`calc(100%-${config.starSize*config.numberOfStars}px)`:''});return loader;function createTextElements(config){const topElement=document.createElement('div');const bottomElement=document.createElement('div');Object.assign(topElement.style,{fontSize:`${config.textSettings.size}px`,lineHeight:'1.2',fontFamily:config.fontSettings,textAlign:config.align,color:config.textSettings.color});topElement.innerHTML=config.texts.top;Object.assign(bottomElement.style,{fontSize:`${config.textSettings.size}px`,lineHeight:'1.2',fontFamily:config.fontSettings,textAlign:config.align,color:config.textSettings.color});const formattedBottomText=config.texts.bottom.replace(/\$average\$/g,'<span class="kozyr-SRS-average">0</span>').replace(/\$votes\$/g,'<span class="kozyr-SRS-votes">0</span>').replace(/\$max\$/g,config.numberOfStars);bottomElement.innerHTML=formattedBottomText;return{top:topElement,bottom:bottomElement}}function createStarsContainer(config){const container=document.createElement('div');container.style.width=`${config.starSize*config.numberOfStars}px`;container.style.display='inline-block';for(let i=1;i<=config.numberOfStars;i++){const star=createStar(i,config);container.appendChild(star)}return container}function createStar(index,config){const star=document.createElement('star');Object.assign(star.style,{display:'inline-block',width:`${config.starSize}px`,cursor:!localStorage['bsrgl_'+config.name]&&!config.readonly?'pointer':'inherit',lineHeight:'0'});star.setAttribute('value',index);const fullStar=createStarComponent('full',config.starImages.full,config.starSize);const emptyStar=createStarComponent('empty',config.starImages.empty,config.starSize);const hoverStar=createStarComponent('hover',config.starImages.hover||config.starImages.full,config.starSize);star.appendChild(fullStar);star.appendChild(emptyStar);star.appendChild(hoverStar);if(!config.readonly){setupStarInteraction(star,config)}return star}function createStarComponent(type,imageSrc,size){const container=document.createElement(type);container.style.display='inline-block';container.style.overflow='hidden';const img=document.createElement('img');Object.assign(img.style,{boxSizing:'border-box',border:'0',padding:'0',margin:'0',maxWidth:'100%',width:`${size}px`});img.src=imageSrc;container.appendChild(img);return container}function setupStarInteraction(star,config){star.onmouseenter=function(){if(!localStorage['bsrgl_'+config.name]){handleStarHover(star,config)}};star.onclick=function(){handleStarClick(star,config)}}function handleStarHover(star,config){const stars=star.parentNode.getElementsByTagName('star');const starIndex=parseInt(star.getAttribute('value'))-1;Array.from(stars).forEach((s,i)=>{if(i<=starIndex){setStarDisplay(s,'full',config.starSize)}else{setStarDisplay(s,'empty',config.starSize)}});if(config.texts.top){const topTextElement=star.parentNode.previousSibling;topTextElement.innerHTML=`${starIndex+1}/${config.numberOfStars}`}}function initializeFirebase(container,config,currentUrl){if(config.firebaseURL.indexOf('Ошибка')<0){const firebaseConfig={databaseURL:config.firebaseURL};const app=firebase.initializeApp(firebaseConfig,config.name+StarRatingGenerator);const databaseRef=app.database().ref(`StarRatingSystem/${currentUrl}/${config.name}`);setupFirebaseListeners(databaseRef,container,config)}else{container.innerHTML=config.firebaseURL}}function setupFirebaseListeners(databaseRef,container,config){databaseRef.on('value',snapshot=>{const data=snapshot.val()||{OO:0,O0:0};handleDataUpdate(data,container,config)})}function handleDataUpdate(data,container,config){updateStars(container,data.OO*config.numberOfStars,config.starSize);removeLoader(container);setupStarBehavior(container,data,config);updateStatistics(container,data,config)}function removeLoader(container){const loader=container.querySelector('.kozyr-SRS-loader');if(container.contains(loader)){loader.remove()}}function setupStarBehavior(container,data,config){const starsContainer=container.getElementsByTagName('div')[1];starsContainer.onmouseleave=()=>{updateStars(container,data.OO*config.numberOfStars,config.starSize);const topTextElement=container.firstChild;topTextElement.innerHTML=config.texts.top};if(!config.readonly){setupStarClickHandlers(container,data,config,starsContainer)}}function updateStatistics(container,data,config){container.querySelectorAll('.kozyr-SRS-average').forEach(el=>el.textContent=Math.round(data.OO*config.numberOfStars*100)/100);container.querySelectorAll('.kozyr-SRS-votes').forEach(el=>el.textContent=data.O0)}function setupStarClickHandlers(container,data,config,starsContainer){container.querySelectorAll('star').forEach((star,index)=>{star.onclick=()=>handleStarClick(star,index,data,config,container)})}function handleStarClick(star,index,data,config,container){if(!localStorage['bsrgl_'+config.name]){const rating=index+1;const newAverage=(data.OO*data.O0+rating/config.numberOfStars)/(data.O0+1);updateRating(config.name,{OO:newAverage,O0:data.O0+1});localStorage['bsrgl_'+config.name]=rating;disableStarInteraction(container);showThankYouMessage(config.texts.thankYou,container,rating);resetTopText(container,config)}else{showThankYouMessage(config.firebaseURL,container,localStorage['bsrgl_'+config.name])}}function disableStarInteraction(container){container.querySelectorAll('star').forEach(star=>{star.style.cursor='inherit'})}function resetTopText(container,config){const topTextElement=container.querySelector('div');topTextElement.innerHTML=config.texts.top}function initialize(index){if(typeof firebase==='object'&&typeof firebase.database==='function'&&typeof firebase.initializeApp==='function'){initializeRating(index)}else{setTimeout(()=>initialize(index),50)}}initialize(starRatingGeneratorIndex)})(StarRatingGenerator);
